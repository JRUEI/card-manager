<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>åˆ·å¡å›é¥‹ç®¡å®¶</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0f0f13; --surface:#18181f; --surface2:#22222d; --border:#2e2e3d;
  --text:#e8e8f0; --muted:#7a7a99; --radius:16px; --radius-sm:10px;
  --danger:#f76f6f; --success:#6ff7a2;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:'Noto Sans TC',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding-bottom:90px}

header{background:#12121a;padding:16px 16px 12px;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
header h1{font-size:1.1rem;font-weight:700;display:flex;align-items:center;gap:8px}
header p{font-size:0.72rem;color:var(--muted);margin-top:2px}

.tabs{display:flex;background:var(--surface2);border-bottom:1px solid var(--border);position:sticky;top:57px;z-index:99}
.tab{flex:1;padding:11px 0;text-align:center;font-size:0.82rem;font-weight:500;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;transition:all .2s}
.tab.active{color:var(--text);border-color:#7c6ff7}

main{padding:14px;max-width:600px;margin:0 auto}

.month-nav{display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:14px;margin-top:4px}
.month-nav button{background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:50%;width:32px;height:32px;cursor:pointer;font-size:1.1rem;display:flex;align-items:center;justify-content:center}
.month-label{font-size:1rem;font-weight:600;min-width:110px;text-align:center}

.summary-row{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px}
.summary-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 8px;text-align:center}
.summary-card .val{font-family:'DM Mono',monospace;font-size:1rem;font-weight:500}
.summary-card .lbl{font-size:0.65rem;color:var(--muted);margin-top:2px}

.sort-toggle{display:flex;justify-content:flex-end;margin-bottom:8px}
.sort-btn{background:var(--surface2);border:1px solid var(--border);color:var(--muted);border-radius:8px;padding:5px 12px;font-size:0.75rem;cursor:pointer;font-family:'Noto Sans TC',sans-serif;transition:all .2s}
.sort-btn.active{border-color:#7c6ff7;color:#7c6ff7;background:rgba(124,111,247,0.1)}

.card-list{display:flex;flex-direction:column;gap:10px}
.card-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;transition:box-shadow .2s,opacity .2s}
.card-item.dragging{opacity:0.4;box-shadow:0 8px 32px rgba(0,0,0,0.5)}
.card-item.drag-over{box-shadow:0 0 0 2px #7c6ff7}

.drag-handle{display:none;align-items:center;justify-content:center;width:36px;flex-shrink:0;cursor:grab;color:var(--muted);font-size:1.1rem;touch-action:none}
.drag-handle:active{cursor:grabbing}
.sort-mode .drag-handle{display:flex}
.sort-mode .card-header{cursor:default}

.card-header{display:flex;align-items:center;justify-content:space-between;padding:13px 14px;cursor:pointer;user-select:none;border-left:4px solid var(--cc,#7c6ff7)}
.sort-mode .card-header{padding-left:0}
.card-left{display:flex;align-items:center;gap:11px}
.bank-chip{width:58px;height:38px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:0.85rem;font-weight:900;color:#fff;flex-shrink:0;letter-spacing:0.02em;text-shadow:0 1px 4px rgba(0,0,0,0.5)}
.card-name{font-size:0.88rem;font-weight:600}
.card-sub{font-size:0.7rem;color:var(--muted);margin-top:1px}
.card-right{display:flex;align-items:center;gap:6px}
.pct-badge{font-size:0.7rem;padding:2px 8px;border-radius:20px;font-weight:600;color:#fff;opacity:.9}
.remain-badge{font-size:0.68rem;padding:2px 8px;border-radius:20px;font-weight:600;white-space:nowrap;font-family:'DM Mono',monospace}
.remain-badge.has-room{background:rgba(111,247,194,0.15);color:#6ff7c2}
.remain-badge.full{background:rgba(247,111,111,0.15);color:#f76f6f}

.card-body{padding:0 14px 14px;display:none}
.card-body.open{display:block}
.sort-mode .card-body{display:none!important}

.prog-wrap{margin-bottom:11px}
.prog-label{display:flex;justify-content:space-between;font-size:0.73rem;color:var(--muted);margin-bottom:5px}
.prog-label .right{font-family:'DM Mono',monospace;color:var(--text)}
.prog-track{height:9px;background:var(--surface2);border-radius:10px;overflow:hidden;border:1px solid var(--border)}
.prog-fill{height:100%;border-radius:10px;transition:width .5s cubic-bezier(.22,.61,.36,1)}

.stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;margin-bottom:11px}
.stat-box{background:var(--surface2);border-radius:8px;padding:9px 6px;text-align:center}
.stat-box .v{font-family:'DM Mono',monospace;font-size:0.88rem;font-weight:500}
.stat-box .l{font-size:0.63rem;color:var(--muted);margin-top:2px}

.add-txn-btn{width:100%;padding:9px;border-radius:8px;border:1px dashed var(--border);background:transparent;color:var(--muted);font-size:.8rem;cursor:pointer;margin-bottom:10px;transition:all .2s;font-family:'Noto Sans TC',sans-serif}

/* CARD INFO SECTIONS */
.card-info-block{margin-bottom:10px}
.card-info-label{font-size:.68rem;color:var(--muted);margin-bottom:4px;display:flex;align-items:center;gap:4px}
.card-link{display:inline-flex;align-items:center;gap:6px;font-size:.8rem;color:#7c6ff7;text-decoration:none;background:rgba(124,111,247,.1);border:1px solid rgba(124,111,247,.25);border-radius:8px;padding:7px 12px;width:100%;overflow:hidden}
.card-link span{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}
.card-link:hover{background:rgba(124,111,247,.2)}
.card-memo{font-size:.78rem;color:var(--text);background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 12px;line-height:1.6;white-space:pre-wrap;word-break:break-all}
.min-spend-alert{display:flex;align-items:flex-start;gap:8px;background:rgba(247,162,111,.08);border:1px solid rgba(247,162,111,.25);border-radius:8px;padding:9px 12px}
.min-spend-alert .icon{font-size:1rem;flex-shrink:0;margin-top:1px}
.min-spend-alert .text{font-size:.78rem;color:#f7c26f;line-height:1.5}
.form-group textarea{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:10px 12px;font-size:.88rem;outline:none;transition:border-color .2s;font-family:'Noto Sans TC',sans-serif;resize:vertical;min-height:80px;line-height:1.5}
.form-group textarea:focus{border-color:#7c6ff7}

.txn-list{display:flex;flex-direction:column;gap:5px;margin-bottom:10px;max-height:220px;overflow-y:auto}
.txn-item{display:flex;align-items:center;justify-content:space-between;background:var(--surface2);border-radius:8px;padding:8px 10px;font-size:.78rem}
.txn-left{display:flex;flex-direction:column;gap:1px;min-width:0}
.txn-name{font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.txn-meta{color:var(--muted);font-size:.68rem}
.txn-right{display:flex;align-items:center;gap:8px;flex-shrink:0}
.txn-amt{font-family:'DM Mono',monospace;font-size:.88rem}
.txn-del{background:none;border:none;color:var(--muted);cursor:pointer;font-size:.85rem;padding:2px 4px}
.txn-del:hover{color:var(--danger)}
.txn-edit{background:none;border:none;color:var(--muted);cursor:pointer;font-size:.78rem;padding:2px 4px}
.txn-edit:hover{color:#7c6ff7}

/* BILLING TAB */
.billing-list{display:flex;flex-direction:column;gap:8px}
.billing-item{display:flex;align-items:center;gap:12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:11px 14px;border-left:4px solid var(--bc,#7c6ff7)}
.billing-bank{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
.billing-chip{width:58px;height:38px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:0.85rem;font-weight:900;color:#fff;flex-shrink:0;text-shadow:0 1px 4px rgba(0,0,0,0.5)}
.billing-name{font-size:.85rem;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.billing-sub{font-size:.68rem;color:var(--muted);margin-top:1px}
.billing-day{font-family:'DM Mono',monospace;font-size:.9rem;color:var(--text);text-align:right;flex-shrink:0;line-height:1.6}
.billing-day span{font-size:.62rem;color:var(--muted);font-family:'Noto Sans TC',sans-serif;display:block}
.billing-day-input{
  font-family:'DM Mono',monospace;font-size:1rem;font-weight:700;color:var(--text);
  background:var(--surface2);border:1px solid var(--border);border-radius:6px;
  width:48px;text-align:center;padding:4px 4px;outline:none;
  transition:border-color .2s;
}
.billing-day-input:focus{border-color:#7c6ff7;color:#c4beff}
.billing-day-wrap{display:flex;flex-direction:column;align-items:flex-end;gap:3px}

.rebate-input-row{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.rebate-input-row label{font-size:.75rem;color:var(--muted);white-space:nowrap}
.rebate-input-row input{flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--success);border-radius:8px;padding:8px 10px;font-family:'DM Mono',monospace;font-size:.88rem;outline:none}
.rebate-input-row input:focus{border-color:var(--success)}

.card-actions{display:flex;gap:7px}
.btn-sm{flex:1;padding:7px 8px;border-radius:8px;border:none;font-size:.75rem;font-weight:500;cursor:pointer;font-family:'Noto Sans TC',sans-serif;transition:all .18s}
.btn-edit{background:var(--surface2);color:var(--muted);border:1px solid var(--border)}
.btn-edit:hover{border-color:var(--text);color:var(--text)}
.btn-del{background:var(--surface2);color:var(--danger);border:1px solid var(--border)}
.btn-del:hover{background:var(--danger);color:#fff}

.all-txn-filter{display:flex;gap:8px;margin-bottom:12px;overflow-x:auto;padding-bottom:2px}
.filter-chip{padding:5px 12px;border-radius:20px;border:1px solid var(--border);background:var(--surface2);color:var(--muted);font-size:.75rem;cursor:pointer;white-space:nowrap;transition:all .2s}
.filter-chip.active{background:var(--surface);color:var(--text);border-color:var(--text)}
.all-txn-list{display:flex;flex-direction:column;gap:7px}
.all-txn-item{display:flex;align-items:center;gap:10px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 12px;border-left:3px solid var(--ic,#7c6ff7)}
.all-txn-info{flex:1;min-width:0}
.all-txn-name{font-size:.85rem;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.all-txn-meta{font-size:.68rem;color:var(--muted);margin-top:2px}
.all-txn-right{text-align:right;flex-shrink:0}
.all-txn-amt{font-family:'DM Mono',monospace;font-size:.92rem}
.all-txn-card{font-size:.65rem;color:var(--muted)}
.all-txn-del{background:none;border:none;color:var(--muted);cursor:pointer;padding:4px;font-size:.85rem;flex-shrink:0}
.all-txn-del:hover{color:var(--danger)}

.add-btn{width:100%;padding:13px;border-radius:var(--radius);background:transparent;border:2px dashed var(--border);color:var(--muted);font-size:.88rem;cursor:pointer;margin-top:10px;transition:all .2s;font-family:'Noto Sans TC',sans-serif}
.add-btn:hover{border-color:#7c6ff7;color:#7c6ff7;background:rgba(124,111,247,.05)}

.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;align-items:flex-end;justify-content:center}
.modal-overlay.open{display:flex}
.modal{background:var(--surface);border-radius:var(--radius) var(--radius) 0 0;width:100%;max-width:600px;padding:22px 18px 40px;border-top:1px solid var(--border);max-height:92vh;overflow-y:auto;animation:slideUp .28s cubic-bezier(.22,.61,.36,1)}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal h2{font-size:1rem;margin-bottom:16px}
.form-group{margin-bottom:12px}
.form-group label{display:block;font-size:.75rem;color:var(--muted);margin-bottom:5px}
.form-group input,.form-group select{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:10px 12px;font-size:.88rem;outline:none;transition:border-color .2s;font-family:'Noto Sans TC',sans-serif;-webkit-appearance:none;appearance:none}
.form-group input:focus,.form-group select:focus{border-color:#7c6ff7}
.form-group select option{background:var(--surface2)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.modal-actions{display:flex;gap:9px;margin-top:18px}
.btn-primary{flex:2;padding:12px;border-radius:10px;border:none;background:#7c6ff7;color:#fff;font-size:.92rem;font-weight:600;cursor:pointer;font-family:'Noto Sans TC',sans-serif}
.btn-cancel{flex:1;padding:12px;border-radius:10px;background:var(--surface2);border:1px solid var(--border);color:var(--muted);font-size:.88rem;cursor:pointer;font-family:'Noto Sans TC',sans-serif}

.color-options{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px}
.color-dot{width:30px;height:30px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:transform .15s,border-color .15s}
.color-dot.selected{border-color:#fff;transform:scale(1.18)}
.custom-color-wrap{display:flex;align-items:center;gap:8px;margin-top:10px}
.custom-color-wrap label{font-size:.75rem;color:var(--muted)}
input[type="color"]{width:36px;height:36px;border-radius:50%;border:2px solid var(--border);padding:2px;cursor:pointer;background:none;outline:none}

.cat-chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
.cat-chip{padding:5px 10px;border-radius:16px;border:1px solid var(--border);background:var(--surface2);color:var(--muted);font-size:.73rem;cursor:pointer;transition:all .15s}
.cat-chip.selected{background:rgba(124,111,247,.2);border-color:#7c6ff7;color:#c4beff}

.empty{text-align:center;padding:40px 20px;color:var(--muted)}
.empty .big{font-size:2.5rem;margin-bottom:10px}
.empty p{font-size:.82rem}

.loading-overlay{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:500;gap:14px}
.loading-spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:#7c6ff7;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-overlay p{font-size:.85rem;color:var(--muted)}

/* SAVE STATUS */
.save-status{position:fixed;bottom:16px;right:16px;font-size:0.7rem;color:var(--muted);display:flex;align-items:center;gap:5px;z-index:50;transition:opacity .5s}
.save-dot{width:7px;height:7px;border-radius:50%;background:var(--muted)}
.save-status.saving .save-dot{background:#f7a26f;animation:pulse .8s infinite}
.save-status.saved .save-dot{background:#6ff7a2}
.save-status.error .save-dot{background:var(--danger)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

.toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:#7c6ff7;color:#fff;padding:9px 20px;border-radius:20px;font-size:.82rem;z-index:999;opacity:0;pointer-events:none;transition:opacity .3s;white-space:nowrap}
.toast.show{opacity:1}

::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
</style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <p>é€£æ¥é›²ç«¯è³‡æ–™ä¸­...</p>
</div>

<header>
  <h1>ğŸ’³ åˆ·å¡å›é¥‹ç®¡å®¶</h1>
  <p id="dateLabel"></p>
</header>

<div class="tabs">
  <div class="tab active" id="tab-cards" onclick="switchTab('cards')">ğŸ’³ æˆ‘çš„å¡ç‰‡</div>
  <div class="tab" id="tab-txns" onclick="switchTab('txns')">ğŸ“‹ æ‰€æœ‰æ¶ˆè²»</div>
  <div class="tab" id="tab-billing" onclick="switchTab('billing')">ğŸ“… çµå¸³æ—¥</div>
</div>

<main>
  <div id="view-cards">
    <div class="month-nav">
      <button onclick="changeMonth(-1)">â€¹</button>
      <div class="month-label" id="monthLabel"></div>
      <button onclick="changeMonth(1)">â€º</button>
    </div>
    <div class="summary-row">
      <div class="summary-card"><div class="val" id="sumSpend" style="color:#f7a26f">$0</div><div class="lbl">æœ¬æœˆæ¶ˆè²»</div></div>
      <div class="summary-card"><div class="val" id="sumExpect" style="color:#6ff7c2">$0</div><div class="lbl">é è¨ˆå›é¥‹</div></div>
      <div class="summary-card"><div class="val" id="sumActual" style="color:#6ff7a2">$0</div><div class="lbl">å¯¦éš›å›é¥‹</div></div>
    </div>
    <div class="sort-toggle">
      <button class="sort-btn" id="sortBtn" onclick="toggleSortMode()">â ¿ èª¿æ•´é †åº</button>
    </div>
    <div class="card-list" id="cardList"></div>
    <button class="add-btn" onclick="openCardModal()">ï¼‹ æ–°å¢ä¿¡ç”¨å¡</button>
  </div>

  <div id="view-txns" style="display:none">
    <div class="month-nav">
      <button onclick="changeMonth(-1)">â€¹</button>
      <div class="month-label" id="monthLabel2"></div>
      <button onclick="changeMonth(1)">â€º</button>
    </div>
    <div class="all-txn-filter" id="filterChips"></div>
    <div class="all-txn-list" id="allTxnList"></div>
  </div>

  <div id="view-billing" style="display:none">
    <div style="margin-top:4px;margin-bottom:14px;font-size:.78rem;color:var(--muted)">ç›´æ¥é»çµå¸³æ—¥æ•¸å­—å³å¯ä¿®æ”¹ï¼ŒæœƒåŒæ­¥æ›´æ–°è©²è¡Œæ‰€æœ‰å¡ç‰‡</div>
    <div class="billing-list" id="billingList"></div>
  </div>
</main>

<!-- CARD MODAL -->
<div class="modal-overlay" id="cardModal">
  <div class="modal">
    <h2 id="cardModalTitle">âœ¦ æ–°å¢ä¿¡ç”¨å¡</h2>
    <div class="form-group"><label>å¡ç‰‡åç¨±</label><input id="f_name" placeholder="ä¾‹ï¼šåœ‹æ³°CUBEå¡"/></div>
    <div class="form-row">
      <div class="form-group"><label>éŠ€è¡Œ</label>
        <select id="f_bank">
          <option>åœ‹æ³°ä¸–è¯</option><option>ç‰å±±éŠ€è¡Œ</option><option>å°æ–°éŠ€è¡Œ</option>
          <option>æ°¸è±éŠ€è¡Œ</option><option>ä¸­åœ‹ä¿¡è¨—</option><option>å°åŒ—å¯Œé‚¦</option>
          <option>è¯é‚¦éŠ€è¡Œ</option><option>é æ±éŠ€è¡Œ</option><option>æ¸£æ‰“éŠ€è¡Œ</option>
          <option>æ»™è±éŠ€è¡Œ</option><option>èŠ±æ——éŠ€è¡Œ</option><option>å…¶ä»–</option>
        </select>
      </div>
      <div class="form-group"><label>çµå¸³æ—¥ï¼ˆæ¯æœˆï¼‰</label><input id="f_billDay" type="number" min="1" max="31" placeholder="25"/></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>å›é¥‹ %</label><input id="f_pct" type="number" step="0.1" placeholder="3"/></div>
      <div class="form-group"><label>æ¶ˆè²»ä¸Šé™ $</label><input id="f_cap" type="number" placeholder="10000"/></div>
    </div>
    <div class="form-group"><label>å›é¥‹é€±æœŸ</label>
      <select id="f_cycle">
        <option value="billing">å¸³å–®é€±æœŸï¼ˆè·Ÿéš¨çµå¸³æ—¥ï¼‰</option>
        <option value="monthly">æ¯æœˆ 1 æ—¥é‡æ–°è¨ˆç®—</option>
      </select>
    </div>
    <div class="form-group">
      <label>å¡ç‰‡é¡è‰²</label>
      <div class="color-options" id="colorOptions"></div>
      <div class="custom-color-wrap">
        <input type="color" id="customColor" value="#7c6ff7" oninput="selectColor(this.value)"/>
        <label>è‡ªè¨‚ä»»æ„é¡è‰²</label>
      </div>
    </div>
    <div class="form-group"><label>å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label><input id="f_note" placeholder="ä¾‹ï¼šæµ·å¤– 3%ï¼Œåœ‹å…§ 1%"/></div>
    <div class="form-group"><label>ğŸ”— å¡ç‰‡å®˜ç¶²é€£çµï¼ˆé¸å¡«ï¼‰</label><input id="f_url" placeholder="https://www.cathaybank.com.tw/..."/></div>
    <div class="form-group"><label>âš ï¸ ä½æ¶ˆæç¤ºï¼ˆé¸å¡«ï¼‰</label><input id="f_minspend" placeholder="ä¾‹ï¼šå–®ç­†æ»¿ 3,000 æ‰æœ‰å›é¥‹"/></div>
    <div class="form-group"><label>ğŸ“ å¡ç‰‡ç­†è¨˜ï¼ˆé¸å¡«ï¼‰</label><textarea id="f_memo" placeholder="è¨˜éŒ„é€™å¼µå¡çš„ä½¿ç”¨æŠ€å·§ã€é™åˆ¶æ¢ä»¶..."></textarea></div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeCardModal()">å–æ¶ˆ</button>
      <button class="btn-primary" onclick="saveCard()">å„²å­˜</button>
    </div>
  </div>
</div>

<!-- TXN MODAL -->
<div class="modal-overlay" id="txnModal">
  <div class="modal">
    <h2 id="txnModalTitle">ğŸ“ æ–°å¢æ¶ˆè²»</h2>
    <div class="form-row">
      <div class="form-group"><label>é‡‘é¡ $</label><input id="t_amt" type="number" placeholder="0"/></div>
      <div class="form-group"><label>æ—¥æœŸ</label><input id="t_date" type="date"/></div>
    </div>
    <div class="form-group"><label>åç¨± / åº—å®¶</label><input id="t_name" placeholder="ä¾‹ï¼šå…¨å®¶ã€Netflix"/></div>
    <div class="form-group"><label>åˆ†é¡</label><div class="cat-chips" id="catChips"></div></div>
    <div class="form-group"><label>å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label><input id="t_note" placeholder=""/></div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeTxnModal()">å–æ¶ˆ</button>
      <button class="btn-primary" id="txnSaveBtn" onclick="saveTxn()">æ–°å¢</button>
    </div>
  </div>
</div>

<div class="save-status" id="saveStatus">
  <div class="save-dot"></div>
  <span id="saveLabel">å·²åŒæ­¥</span>
</div>
<div class="toast" id="toast"></div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// â”€â”€â”€ FIREBASE INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const firebaseConfig = {
  apiKey: "AIzaSyBgbDaBhwhzDWFUqMeoJNHTfQXcwjlgEW4",
  authDomain: "card-manager-6d8e4.firebaseapp.com",
  projectId: "card-manager-6d8e4",
  storageBucket: "card-manager-6d8e4.firebasestorage.app",
  messagingSenderId: "869363300263",
  appId: "1:869363300263:web:5c5098b9d6fa9c14682882",
  measurementId: "G-P53X9WHBB1"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const DOC = doc(db, "data", "main");

// â”€â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PRESET_COLORS=['#7c6ff7','#4f46e5','#0ea5e9','#10b981','#f59e0b','#ef4444','#ec4899','#8b5cf6','#14b8a6','#f97316','#06b6d4','#84cc16','#e11d48','#0284c7'];
const CATEGORIES=['é¤é£²','è¶…å¸‚','äº¤é€š','å¨›æ¨‚','è³¼ç‰©','æ—…éŠ','é†«ç™‚','åŠ æ²¹','è¨‚é–±','å…¶ä»–'];
const MN=['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
const BANK_BILL_DAYS={
  'åœ‹æ³°ä¸–è¯':17,'ç‰å±±éŠ€è¡Œ':12,'å°æ–°éŠ€è¡Œ':20,'æ°¸è±éŠ€è¡Œ':25,
  'ä¸­åœ‹ä¿¡è¨—':20,'å°åŒ—å¯Œé‚¦':14,'è¯é‚¦éŠ€è¡Œ':25,'é æ±éŠ€è¡Œ':25,
  'æ¸£æ‰“éŠ€è¡Œ':20,'æ»™è±éŠ€è¡Œ':20,'èŠ±æ——éŠ€è¡Œ':14,'å…¶ä»–':null
};

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let cards=[], txns=[], rebate={};
const now=new Date();
let viewYear=now.getFullYear(), viewMonth=now.getMonth();
let currentTab='cards', editCardId=null, txnCardId=null, editTxnId=null;
let selectedColor='#7c6ff7', selectedCat='å…¶ä»–', filterCard='all';
let sortMode=false, dragSrcIdx=null;
let saveTimer=null;

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const mkey=()=>`${viewYear}-${String(viewMonth+1).padStart(2,'0')}`;
const fmt=n=>Number(n||0).toLocaleString('zh-TW');
const esc=s=>String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,5);
const getMonthTxns=id=>txns.filter(t=>t.cardId===id&&t.date.startsWith(mkey()));
const getMonthSpend=id=>getMonthTxns(id).reduce((s,t)=>s+Number(t.amt||0),0);
const getActual=id=>Number(rebate[`${id}_${mkey()}`]||0);

function getBillingPeriod(billDay) {
  const today=new Date();
  const bd=Number(billDay)||25;
  const d=today.getDate();
  // if today is on or before billDay, current period ends this month on billDay
  // if today is after billDay, current period ends next month
  let endY=today.getFullYear(), endM=today.getMonth();
  if(d>bd){ endM++; if(endM>11){endM=0;endY++;} }
  let startM=endM-1, startY=endY;
  if(startM<0){startM=11;startY--;}
  const startD=bd+1;
  // handle if startD overflows the start month
  const daysInStart=new Date(startY,startM+1,0).getDate();
  let sd=startD,sm=startM,sy=startY;
  if(sd>daysInStart){sd=1;sm++;if(sm>11){sm=0;sy++;}}
  return `${sm+1}/${sd} - ${endM+1}/${bd}`;
}

function setSaveStatus(status, label) {
  const el=document.getElementById('saveStatus');
  const lb=document.getElementById('saveLabel');
  el.className='save-status '+status;
  lb.textContent=label;
}

// â”€â”€â”€ FIRESTORE LOAD / SAVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function load() {
  try {
    setSaveStatus('saving','é€£ç·šä¸­...');
    const snap = await getDoc(DOC);
    if (snap.exists()) {
      const d = snap.data();
      cards  = d.cards  || [];
      txns   = d.txns   || [];
      rebate = d.rebate || {};
    }
    setSaveStatus('saved','å·²åŒæ­¥');
  } catch(e) {
    setSaveStatus('error','é€£ç·šå¤±æ•—');
    showToast('âš ï¸ ç„¡æ³•é€£æ¥é›²ç«¯ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
  }
  document.getElementById('loadingOverlay').style.display='none';
  render();
}

function scheduleSave() {
  setSaveStatus('saving','å„²å­˜ä¸­...');
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(async ()=>{
    try {
      await setDoc(DOC, { cards, txns, rebate });
      setSaveStatus('saved','å·²åŒæ­¥ âœ“');
    } catch(e) {
      setSaveStatus('error','å„²å­˜å¤±æ•— âœ—');
      showToast('âš ï¸ å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
    }
  }, 800); // debounce 800ms
}

function setActualStore(id,v) {
  rebate[`${id}_${mkey()}`]=Number(v)||0;
  scheduleSave();
}

// â”€â”€â”€ TAB / MONTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  currentTab=tab;
  document.getElementById('view-cards').style.display=tab==='cards'?'':'none';
  document.getElementById('view-txns').style.display=tab==='txns'?'':'none';
  document.getElementById('view-billing').style.display=tab==='billing'?'':'none';
  document.getElementById('tab-cards').classList.toggle('active',tab==='cards');
  document.getElementById('tab-txns').classList.toggle('active',tab==='txns');
  document.getElementById('tab-billing').classList.toggle('active',tab==='billing');
  render();
}
window.switchTab=switchTab;

function changeMonth(d){
  viewMonth+=d;
  if(viewMonth>11){viewMonth=0;viewYear++}
  if(viewMonth<0){viewMonth=11;viewYear--}
  render();
}
window.changeMonth=changeMonth;

// â”€â”€â”€ SORT MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSortMode(){
  sortMode=!sortMode;
  const btn=document.getElementById('sortBtn');
  btn.textContent=sortMode?'âœ“ å®Œæˆæ’åº':'â ¿ èª¿æ•´é †åº';
  btn.classList.toggle('active',sortMode);
  document.getElementById('cardList').classList.toggle('sort-mode',sortMode);
  render();
}
window.toggleSortMode=toggleSortMode;

// â”€â”€â”€ DRAG & DROP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let touchDragEl=null, touchDragIdx=null, touchStartY=0, touchClone=null;

function initDrag(el, idx) {
  el.draggable=true;
  el.addEventListener('dragstart',e=>{
    dragSrcIdx=idx;
    setTimeout(()=>el.classList.add('dragging'),0);
    e.dataTransfer.effectAllowed='move';
  });
  el.addEventListener('dragend',()=>{
    el.classList.remove('dragging');
    document.querySelectorAll('.card-item').forEach(x=>x.classList.remove('drag-over'));
  });
  el.addEventListener('dragover',e=>{
    e.preventDefault();
    document.querySelectorAll('.card-item').forEach(x=>x.classList.remove('drag-over'));
    el.classList.add('drag-over');
  });
  el.addEventListener('drop',e=>{
    e.preventDefault();
    el.classList.remove('drag-over');
    if(dragSrcIdx===null||dragSrcIdx===idx)return;
    const moved=cards.splice(dragSrcIdx,1)[0];
    cards.splice(idx,0,moved);
    dragSrcIdx=null;
    scheduleSave(); render();
  });

  const handle=el.querySelector('.drag-handle');
  if(!handle)return;
  handle.addEventListener('touchstart',e=>{
    if(!sortMode)return;
    touchDragIdx=idx; touchDragEl=el;
    touchStartY=e.touches[0].clientY;
    touchClone=el.cloneNode(true);
    const r=el.getBoundingClientRect();
    touchClone.style.cssText=`position:fixed;left:${r.left}px;top:${r.top}px;width:${el.offsetWidth}px;opacity:.85;z-index:300;pointer-events:none;box-shadow:0 8px 32px rgba(0,0,0,.5)`;
    document.body.appendChild(touchClone);
    el.style.opacity='0.3';
    e.preventDefault();
  },{passive:false});
  handle.addEventListener('touchmove',e=>{
    if(touchDragIdx===null)return;
    const dy=e.touches[0].clientY-touchStartY;
    const r=touchDragEl.getBoundingClientRect();
    touchClone.style.top=(r.top+dy)+'px';
    const els=[...document.querySelectorAll('.card-item')];
    const my=e.touches[0].clientY;
    els.forEach(x=>x.classList.remove('drag-over'));
    els.forEach((x,i)=>{
      const xr=x.getBoundingClientRect();
      if(my>xr.top&&my<xr.bottom&&i!==touchDragIdx) x.classList.add('drag-over');
    });
    e.preventDefault();
  },{passive:false});
  handle.addEventListener('touchend',e=>{
    if(touchDragIdx===null)return;
    document.body.removeChild(touchClone); touchClone=null;
    touchDragEl.style.opacity='';
    const els=[...document.querySelectorAll('.card-item')];
    els.forEach(x=>x.classList.remove('drag-over'));
    const my=e.changedTouches[0].clientY;
    let targetI=touchDragIdx;
    els.forEach((x,i)=>{const r=x.getBoundingClientRect();if(my>r.top&&my<r.bottom)targetI=i});
    if(targetI!==touchDragIdx){
      const moved=cards.splice(touchDragIdx,1)[0];
      cards.splice(targetI,0,moved);
      scheduleSave();
    }
    touchDragIdx=null; touchDragEl=null;
    render();
  });
}

// â”€â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(){
  const lbl=`${viewYear} å¹´ ${MN[viewMonth]}`;
  document.getElementById('monthLabel').textContent=lbl;
  document.getElementById('monthLabel2').textContent=lbl;
  document.getElementById('dateLabel').textContent=`ä»Šæ—¥ï¼š${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()}`;
  if(currentTab==='cards')renderCards();
  else if(currentTab==='txns')renderAllTxns();
  else renderBilling();
}

function renderCards(){
  const list=document.getElementById('cardList');
  list.innerHTML='';
  list.classList.toggle('sort-mode',sortMode);
  let ss=0,se=0,sa=0;
  if(!cards.length){
    list.innerHTML=`<div class="empty"><div class="big">ğŸ’³</div><p>å°šç„¡å¡ç‰‡ï¼Œé»ä¸‹æ–¹æŒ‰éˆ•æ–°å¢ï¼</p></div>`;
  }
  cards.forEach((c,idx)=>{
    const color=c.color||'#7c6ff7';
    const spend=getMonthSpend(c.id);
    const actual=getActual(c.id);
    const cap=Number(c.cap)||0;
    const pct=Number(c.pct)||0;
    const expect=Math.round(Math.min(spend,cap)*pct/100);
    const prog=cap>0?Math.min(spend/cap,1):0;
    const progN=Math.round(prog*100);
    ss+=spend; se+=expect; sa+=actual;
    const fillColor=progN>=100?'#6ff7a2':progN>=80?'#f59e0b':color;
    const monthT=getMonthTxns(c.id);
    const bankAbbr=(c.bank||'éŠ€').slice(0,2);
    const remainBadge=cap>0
      ?(spend>=cap
        ?`<span class="remain-badge full">å·²æ»¿é¡</span>`
        :`<span class="remain-badge has-room">é‚„å¯åˆ· $${fmt(cap-spend)}</span>`)
      :'';
    const txnHTML=monthT.length===0
      ?`<div style="font-size:.75rem;color:var(--muted);text-align:center;padding:8px">æœ¬æœˆå°šç„¡æ¶ˆè²»è¨˜éŒ„</div>`
      :monthT.slice().reverse().map(t=>`
        <div class="txn-item">
          <div class="txn-left">
            <div class="txn-name">${esc(t.name||'æ¶ˆè²»')}</div>
            <div class="txn-meta">${t.date} Â· ${esc(t.cat||'å…¶ä»–')}${t.note?' Â· '+esc(t.note):''}</div>
          </div>
          <div class="txn-right">
            <div class="txn-amt">$${fmt(t.amt)}</div>
            <button class="txn-edit" onclick="editTxn('${t.id}','${c.id}')">âœ</button>
            <button class="txn-del" onclick="delTxn('${t.id}')">âœ•</button>
          </div>
        </div>`).join('');

    const div=document.createElement('div');
    div.className='card-item';
    div.innerHTML=`
      <div class="card-header" style="--cc:${color}" onclick="headerClick(event,'${c.id}')">
        <div class="drag-handle">â ¿</div>
        <div class="card-left">
          <div class="bank-chip" style="background:${color}">${esc(bankAbbr)}</div>
          <div>
            <div class="card-name">${esc(c.name)}</div>
            <div class="card-sub">${c.note?esc(c.note):`${pct}% å›é¥‹ Â· ä¸Šé™ $${fmt(cap)}`}</div>
          </div>
        </div>
        <div class="card-right" style="display:flex;align-items:center;gap:8px;flex-shrink:0">
          <span class="pct-badge" style="background:${color};font-size:.85rem;padding:6px 10px;line-height:1;flex-shrink:0">${pct}%</span>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;width:100px">
            <div style="display:flex;justify-content:flex-end;width:100%">
              ${remainBadge||`<span style="font-size:.65rem;color:var(--muted)">ç„¡ä¸Šé™</span>`}
            </div>
            <span style="font-size:.65rem;color:var(--muted);font-family:'DM Mono',monospace;white-space:nowrap">
              ${c.cycle==='billing'?getBillingPeriod(c.billDay):'æ¯æœˆ1æ—¥èµ·'}
            </span>
          </div>
          <span style="color:var(--muted);font-size:.8rem;flex-shrink:0" id="chev_${c.id}">â–¼</span>
        </div>
      </div>
      <div class="card-body" id="body_${c.id}">
        <div class="prog-wrap">
          <div class="prog-label"><span>æ¶ˆè²»é€²åº¦</span><span class="right">${progN}%ã€€$${fmt(spend)} / $${fmt(cap)}</span></div>
          <div class="prog-track"><div class="prog-fill" style="width:${progN}%;background:${fillColor}"></div></div>
        </div>
        <div class="stats-row">
          <div class="stat-box"><div class="v" style="color:#f7a26f">$${fmt(spend)}</div><div class="l">æœ¬æœˆæ¶ˆè²»</div></div>
          <div class="stat-box"><div class="v" style="color:#6ff7c2">$${fmt(expect)}</div><div class="l">é è¨ˆå›é¥‹</div></div>
          <div class="stat-box"><div class="v" style="color:#6ff7a2">$${fmt(actual)}</div><div class="l">å¯¦éš›å›é¥‹</div></div>
        </div>
        <button class="add-txn-btn" style="border-color:${color};color:${color}" onclick="openTxnModal('${c.id}')">ï¼‹ æ–°å¢æ¶ˆè²»è¨˜éŒ„</button>
        <div class="txn-list">${txnHTML}</div>
        <div class="rebate-input-row">
          <label>å¯¦éš›å›é¥‹å…¥å¸³ $</label>
          <input type="number" value="${actual||''}" placeholder="å°šæœªå…¥å¸³"
            onchange="setActualStore('${c.id}',this.value);render()"/>
        </div>
        ${c.minspend ? `
        <div class="min-spend-alert">
          <div class="icon">âš ï¸</div>
          <div class="text">${esc(c.minspend)}</div>
        </div>` : ''}
        ${c.memo ? `
        <div class="card-info-block">
          <div class="card-info-label">ğŸ“ ç­†è¨˜</div>
          <div class="card-memo">${esc(c.memo)}</div>
        </div>` : ''}
        ${c.url ? `
        <div class="card-info-block">
          <div class="card-info-label">ğŸ”— å¡ç‰‡å®˜ç¶²</div>
          <a class="card-link" href="${esc(c.url)}" target="_blank" rel="noopener">
            <span>ğŸŒ</span><span>${esc(c.url)}</span>
          </a>
        </div>` : ''}
        <div style="font-size:.7rem;color:var(--muted);margin-bottom:10px;margin-top:4px">
          ğŸ“… ${c.cycle==='billing'
            ? `æœ¬æœŸå¸³å–®ï¼š${getBillingPeriod(c.billDay)}ï¼ˆçµå¸³æ—¥æ¯æœˆ ${c.billDay||25} æ—¥ï¼‰`
            : `æ¯æœˆ 1 æ—¥èµ·ç®—`}
        </div>
        <div class="card-actions">
          <button class="btn-sm btn-edit" onclick="openCardModal('${c.id}')">âœ ç·¨è¼¯å¡ç‰‡</button>
          <button class="btn-sm btn-del" onclick="delCard('${c.id}')">âœ• åˆªé™¤</button>
        </div>
      </div>`;
    list.appendChild(div);
    initDrag(div,idx);
  });
  document.getElementById('sumSpend').textContent='$'+fmt(ss);
  document.getElementById('sumExpect').textContent='$'+fmt(se);
  document.getElementById('sumActual').textContent='$'+fmt(sa);
}

function headerClick(e,id){
  if(sortMode)return;
  if(e.target.closest('.drag-handle'))return;
  toggleBody(id);
}
window.headerClick=headerClick;

function toggleBody(id){
  const b=document.getElementById('body_'+id);
  const ch=document.getElementById('chev_'+id);
  const open=b.classList.toggle('open');
  if(ch)ch.textContent=open?'â–²':'â–¼';
}

function renderAllTxns(){
  const chips=document.getElementById('filterChips');
  chips.innerHTML=`<div class="filter-chip ${filterCard==='all'?'active':''}" onclick="setFilter('all')">å…¨éƒ¨</div>`;
  cards.forEach(c=>{
    const isA=filterCard===c.id;
    chips.innerHTML+=`<div class="filter-chip ${isA?'active':''}" style="${isA?`border-color:${c.color||'#7c6ff7'};color:${c.color||'#7c6ff7'}`:''}" onclick="setFilter('${c.id}')">${esc(c.name)}</div>`;
  });
  const list=document.getElementById('allTxnList');
  let filtered=txns.filter(t=>t.date.startsWith(mkey()));
  if(filterCard!=='all')filtered=filtered.filter(t=>t.cardId===filterCard);
  filtered.sort((a,b)=>b.date.localeCompare(a.date));
  if(!filtered.length){list.innerHTML=`<div class="empty"><div class="big">ğŸ§¾</div><p>æœ¬æœˆç„¡æ¶ˆè²»è¨˜éŒ„</p></div>`;return}
  list.innerHTML=filtered.map(t=>{
    const card=cards.find(c=>c.id===t.cardId);
    const color=card?.color||'#7c6ff7';
    return `<div class="all-txn-item" style="--ic:${color}">
      <div class="all-txn-info">
        <div class="all-txn-name">${esc(t.name||'æ¶ˆè²»')}</div>
        <div class="all-txn-meta">${t.date} Â· ${esc(t.cat||'å…¶ä»–')}${t.note?' Â· '+esc(t.note):''}</div>
      </div>
      <div class="all-txn-right">
        <div class="all-txn-amt" style="color:${color}">$${fmt(t.amt)}</div>
        <div class="all-txn-card">${card?esc(card.name):'å·²åˆªé™¤'}</div>
      </div>
      <button class="txn-edit" onclick="editTxn('${t.id}','${t.cardId}')" style="font-size:.9rem;padding:4px 6px">âœ</button>
      <button class="all-txn-del" onclick="delTxn('${t.id}')">âœ•</button>
    </div>`;
  }).join('');
}
window.setFilter=id=>{filterCard=id;render()};

function renderBilling(){
  const list=document.getElementById('billingList');
  if(!cards.length){list.innerHTML=`<div class="empty"><div class="big">ğŸ“…</div><p>å°šç„¡å¡ç‰‡</p></div>`;return}
  // Group by bank
  const bankMap={};
  cards.forEach(c=>{
    if(!bankMap[c.bank]) bankMap[c.bank]={bank:c.bank,color:c.color||'#7c6ff7',billDay:c.billDay,cards:[]};
    bankMap[c.bank].cards.push(c.name);
    // use lowest billDay if mismatch (shouldn't happen but safety)
    if(!bankMap[c.bank].billDay && c.billDay) bankMap[c.bank].billDay=c.billDay;
  });
  list.innerHTML=Object.values(bankMap).map(b=>{
    const abbr=(b.bank||'éŠ€').slice(0,2);
    const day=b.billDay||'';
    const period=day?getBillingPeriod(day):'â€”';
    const cardNames=b.cards.join('ã€');
    const bankKey=encodeURIComponent(b.bank);
    return `<div class="billing-item" style="--bc:${b.color}">
      <div class="billing-bank">
        <div class="billing-chip" style="background:${b.color}">${esc(abbr)}</div>
        <div>
          <div class="billing-name">${esc(b.bank)}</div>
          <div class="billing-sub">${esc(cardNames)}</div>
        </div>
      </div>
      <div class="billing-day-wrap">
        <div style="display:flex;align-items:center;gap:4px">
          <span style="font-size:.68rem;color:var(--muted);font-family:'Noto Sans TC',sans-serif">æ¯æœˆ</span>
          <input class="billing-day-input" type="number" min="1" max="31"
            value="${day}" placeholder="æ—¥"
            onchange="updateBankBillDay('${bankKey}',this.value)"
            onclick="this.select()" />
          <span style="font-size:.68rem;color:var(--muted);font-family:'Noto Sans TC',sans-serif">æ—¥çµå¸³</span>
        </div>
        <span style="font-size:.62rem;color:var(--muted);font-family:'Noto Sans TC',sans-serif;text-align:right" id="bp_${bankKey}">${period}</span>
      </div>
    </div>`;
  }).join('');
}

function updateBankBillDay(bankKey, val){
  const bank=decodeURIComponent(bankKey);
  const day=Math.min(31,Math.max(1,parseInt(val)||1));
  // update all cards of this bank
  cards.forEach(c=>{ if(c.bank===bank) c.billDay=day; });
  scheduleSave();
  // update period display inline without full re-render
  const el=document.getElementById('bp_'+bankKey);
  if(el) el.textContent=getBillingPeriod(day);
}
window.updateBankBillDay=updateBankBillDay;

// â”€â”€â”€ CARD MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildColorPicker(sel){
  selectedColor=sel||'#7c6ff7';
  document.getElementById('colorOptions').innerHTML=PRESET_COLORS.map(c=>`<div class="color-dot ${c===selectedColor?'selected':''}" style="background:${c}" onclick="selectColor('${c}')"></div>`).join('');
  document.getElementById('customColor').value=selectedColor;
}
function selectColor(c){selectedColor=c;document.getElementById('customColor').value=c;buildColorPicker(c)}
window.selectColor=selectColor;

function openCardModal(id){
  editCardId=id||null;
  const c=id?cards.find(x=>x.id===id):null;
  document.getElementById('cardModalTitle').textContent=id?'âœ ç·¨è¼¯ä¿¡ç”¨å¡':'âœ¦ æ–°å¢ä¿¡ç”¨å¡';
  document.getElementById('f_name').value=c?.name||'';
  document.getElementById('f_bank').value=c?.bank||'åœ‹æ³°ä¸–è¯';
  document.getElementById('f_billDay').value=c?.billDay||BANK_BILL_DAYS['åœ‹æ³°ä¸–è¯']||'';
  document.getElementById('f_pct').value=c?.pct||'';
  document.getElementById('f_cap').value=c?.cap||'';
  document.getElementById('f_cycle').value=c?.cycle||'billing';
  document.getElementById('f_note').value=c?.note||'';
  document.getElementById('f_url').value=c?.url||'';
  document.getElementById('f_minspend').value=c?.minspend||'';
  document.getElementById('f_memo').value=c?.memo||'';
  buildColorPicker(c?.color||'#7c6ff7');
  // wire up bank auto-fill (only for new cards)
  const bankSel=document.getElementById('f_bank');
  bankSel.onchange=()=>{
    if(!editCardId){
      const def=BANK_BILL_DAYS[bankSel.value];
      if(def) document.getElementById('f_billDay').value=def;
    }
  };
  document.getElementById('cardModal').classList.add('open');
}
window.openCardModal=openCardModal;

function closeCardModal(){document.getElementById('cardModal').classList.remove('open')}
window.closeCardModal=closeCardModal;

async function saveCard(){
  const name=document.getElementById('f_name').value.trim();
  if(!name){showToast('è«‹è¼¸å…¥å¡ç‰‡åç¨±');return}
  const data={id:editCardId||uid(),name,bank:document.getElementById('f_bank').value,billDay:document.getElementById('f_billDay').value||25,pct:document.getElementById('f_pct').value||0,cap:document.getElementById('f_cap').value||0,cycle:document.getElementById('f_cycle').value,note:document.getElementById('f_note').value.trim(),color:selectedColor,url:document.getElementById('f_url').value.trim(),minspend:document.getElementById('f_minspend').value.trim(),memo:document.getElementById('f_memo').value.trim()};
  if(editCardId){const i=cards.findIndex(x=>x.id===editCardId);if(i>=0)cards[i]=data}
  else cards.push(data);
  scheduleSave();
  closeCardModal(); render(); showToast(editCardId?'å¡ç‰‡å·²æ›´æ–° âœ“':'æ–°å¢æˆåŠŸ âœ“');
}
window.saveCard=saveCard;

async function delCard(id){
  if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™å¼µå¡ç‰‡ï¼Ÿï¼ˆæ¶ˆè²»è¨˜éŒ„ä¹Ÿæœƒä¸€èµ·åˆªé™¤ï¼‰'))return;
  cards=cards.filter(c=>c.id!==id);
  txns=txns.filter(t=>t.cardId!==id);
  scheduleSave(); render(); showToast('å·²åˆªé™¤');
}
window.delCard=delCard;

// â”€â”€â”€ TXN MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildCatChips(sel){
  selectedCat=sel||'å…¶ä»–';
  document.getElementById('catChips').innerHTML=CATEGORIES.map(c=>`<div class="cat-chip ${c===selectedCat?'selected':''}" onclick="selectCat('${c}')">${c}</div>`).join('');
}
function selectCat(c){selectedCat=c;buildCatChips(c)}
window.selectCat=selectCat;

function openTxnModal(cardId){
  editTxnId=null;
  txnCardId=cardId;
  const card=cards.find(c=>c.id===cardId);
  document.getElementById('txnModalTitle').textContent=`ğŸ“ æ–°å¢æ¶ˆè²» â€” ${card?.name||''}`;
  document.getElementById('txnSaveBtn').textContent='æ–°å¢';
  document.getElementById('t_amt').value='';
  document.getElementById('t_name').value='';
  document.getElementById('t_note').value='';
  const td=new Date();
  const y=viewYear,m=String(viewMonth+1).padStart(2,'0');
  const d=td.getFullYear()===viewYear&&td.getMonth()===viewMonth?String(td.getDate()).padStart(2,'0'):String(new Date(viewYear,viewMonth+1,0).getDate()).padStart(2,'0');
  document.getElementById('t_date').value=`${y}-${m}-${d}`;
  buildCatChips('å…¶ä»–');
  document.getElementById('txnModal').classList.add('open');
}
window.openTxnModal=openTxnModal;

function editTxn(txnId, cardId){
  const t=txns.find(x=>x.id===txnId);
  if(!t)return;
  editTxnId=txnId;
  txnCardId=cardId;
  const card=cards.find(c=>c.id===cardId);
  document.getElementById('txnModalTitle').textContent=`âœ ç·¨è¼¯æ¶ˆè²» â€” ${card?.name||''}`;
  document.getElementById('txnSaveBtn').textContent='å„²å­˜';
  document.getElementById('t_amt').value=t.amt;
  document.getElementById('t_name').value=t.name||'';
  document.getElementById('t_note').value=t.note||'';
  document.getElementById('t_date').value=t.date;
  buildCatChips(t.cat||'å…¶ä»–');
  document.getElementById('txnModal').classList.add('open');
}
window.editTxn=editTxn;

function closeTxnModal(){document.getElementById('txnModal').classList.remove('open')}
window.closeTxnModal=closeTxnModal;

async function saveTxn(){
  const amt=parseFloat(document.getElementById('t_amt').value);
  if(!amt||amt<=0){showToast('è«‹è¼¸å…¥é‡‘é¡');return}
  const data={
    id:editTxnId||uid(), cardId:txnCardId, amt,
    date:document.getElementById('t_date').value,
    name:document.getElementById('t_name').value.trim()||'æ¶ˆè²»',
    cat:selectedCat,
    note:document.getElementById('t_note').value.trim()
  };
  if(editTxnId){
    const i=txns.findIndex(t=>t.id===editTxnId);
    if(i>=0)txns[i]=data;
  } else {
    txns.push(data);
  }
  scheduleSave(); closeTxnModal(); render();
  showToast(editTxnId?'å·²æ›´æ–° âœ“':'å·²æ–°å¢ âœ“');
}
window.saveTxn=saveTxn;

function delTxn(id){
  txns=txns.filter(t=>t.id!==id);
  scheduleSave(); render();
}
window.delTxn=delTxn;

window.setActualStore=setActualStore;

function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2200);
}

['cardModal','txnModal'].forEach(id=>{
  document.getElementById(id).addEventListener('click',function(e){if(e.target===this)this.classList.remove('open')});
});

load();
</script>
</body>
</html>
